function copy_user_name(e){return $messenger[0].value+=e,$messenger.focus(),!1}function my_getcookie(e){return cname=e+"=",cpos=document.cookie.indexOf(cname),-1!=cpos?(cstart=cpos+cname.length,cend=document.cookie.indexOf(";",cstart),-1==cend&&(cend=document.cookie.length),unescape(document.cookie.substring(cstart,cend))):null}function my_setcookie(e,t,a,o){expires="",domain="",a&&(expires="; expires=Wed, 1 Jan 2020 00:00:00 GMT"),o||(o="/"),document.cookie=e+"="+t+"; path="+o+expires+domain+";"}function SetCookie(e,t){return my_setcookie(e,t)}var firstTime=!0,$wrap=$("#chatbox-wrap"),$messenger=$("#chatbox-messenger-input"),$form=$("#chatbox-form"),$wform=$("#chatbox-messenger-form"),uId,uName,autoRefresh,$title=$("title"),regexpPM=/^(<span style="color: (#[0-9A-Fa-f]{6}|rgb\(\d{2,3}, \d{2,3}, \d{2,3}\));?">(<(strike|i|u|strong)>)*)(\d{13,}_\d+)({.*})(\["[^"]+"(\,"[^"]+")+\])(.*)$/,lastMess,connected=0,userOnline=function(e){return $("#chatbox-members").find("a[onclick=\"return copy_user_name('"+e+"');\"]")},chatbox_old_update=0,zzEmoFb={all:"",emoFB:{},imgEmo:function(e,t){return'<img class="smiley_FB" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="'+e.replace(/\"/,"&quot;")+'" style="background-position:'+t+'" />'},checkEmo:function(e){return e=e.replace(zzEmoFb.all,function(e){return zzEmoFb.imgEmo(e,zzEmoFb.emoFB[e])})},list:function(e,t){$.each(zzEmoFb.emoFB,function(a,o){e.test(a)&&$(t).append(zzEmoFb.imgEmo(a,o))})},addSmiley:function(e){var t=/\bO:\)\B|\bo\.O\b|\bO\.o\b|\b8\|\B|\b8\)\B|\b3:\)\B|\B(\(y\)\B|\B:3\b|\B:\'\(\B|\B:\(\B|\B:O\b|\B:D\b|\B&gt;:\(\B|\B&lt;3\b|\B\^_\^\B|\B:\*\B|\B:v\b|\B&lt;\(\"\)\B|\B:poop:\B|\B:putnam:\B|\B\(\^\^\^\)\B|\B:\)\B|\B-_-\B|\B:P\b|\B:\/\B|\B&gt;:O\b|\B;\)\B|\B:\|\]\B)/,a=/\B:fb([0-9]|[1-9][0-9]|1[0-9][0-9]|20[0-9]):\B/;zzEmoFb.all=RegExp((t+a).replace("//","|").replace(/^\/|\/$/g,""),"g");for(var o,c=0,n=0;239>n;n++){switch(n){case 210:o="o.O";break;case 211:o="O.o";break;case 212:o=":'(";break;case 213:o="3:)";break;case 214:o=":(";break;case 215:o=":O";break;case 216:o="8)";break;case 217:o=":D";break;case 218:o="&gt;:(";break;case 219:o="&lt;3";break;case 220:o="^_^";break;case 221:o=":*";break;case 222:o=":v";break;case 223:o='&lt;(")';break;case 224:o=":poop:";break;case 225:o=":putnam:";break;case 226:o="(^^^)";break;case 227:o=":)";break;case 228:o="-_-";break;case 229:o="8|";break;case 230:o=":P";break;case 231:o=":/";break;case 232:o="&gt;:O";break;case 233:o=";)";break;case 234:o="(y)";break;case 235:o=":3";break;case 236:o=":|]";break;case 237:o="O:)";break;default:o=":fb"+n+":"}c-=17,zzEmoFb.emoFB[o]="0 "+c+"px"}var s=$("<div>",{id:"smiley_FB_frame"}).appendTo(e);zzEmoFb.list(t,"#smiley_FB_frame"),s.append('<p class="more">--- Xem thêm ---</p>');var i=$(".more",s);i.click(function(){$("p.less",s).length?i.nextAll().show():(zzEmoFb.list(a,"#smiley_FB_frame"),s.append('<p class="less">--- Thu gọn ---</p>')),$(this).hide()}),s.on("click",".less",function(){$(this).hide(),i.show().nextAll().hide()}),s.on("click","img",function(t){$messenger[0].value+=" "+this.alt,t.ctrlKey||($(e).removeClass("active"),$form.submit())}),$(e).click(function(){$(this).toggleClass("active")}),s.click(function(e){e.stopPropagation()}),$(document).click(function(t){$(t.target).closest(e).length||$(e).removeClass("active")})}};zzEmoFb.addSmiley("#chatbox-option-smiley");var regexpPM=/^(<span style="color: (#[0-9A-Fa-f]{6}|rgb\(\d{2,3}, \d{2,3}, \d{2,3}\));?">(<(strike|i|u|strong)>)*)(\d{13,}_\d+)({.*})(\["[^"]+"(\,"[^"]+")+\])(.*)$/,newMessage=function(e){if(e){var t=$.parseHTML(e);$.each(t,function(){var e=$(this),t=$(".msg",e),a=t.html();if(regexpPM.test(a)){var o=a.match(regexpPM),c=JSON.parse(o[7]),n=$.inArray(encodeURIComponent(uName),c);if(-1!==n){var s=o[5],i=$('.chatbox-content[data-id="'+s+'"]'),r=$('.chatbox-change[data-id="'+s+'"]');if(r.length)r.is(":hidden")&&-1===t.text().indexOf("]/out")&&(r.show(),userOnline(r.find("h3").text()).parent().hide());else{i=$("<div>",{"class":"chatbox-content","data-id":s,style:"display: none;"}).appendTo("#chatbox-wrap");var l,h=o[6].slice(1,-1);""===h&&(h=$.grep(c,function(e){return e!==encodeURIComponent(uName)}),1===h.length?(h=decodeURIComponent(h[0]),l=userOnline(h),l.parent().hide()):h=decodeURIComponent(h.join(", "))),r=$("<div>",{"class":"chatbox-change","data-id":s,"data-name":o[6],"data-users":o[7],html:'<h3 style="color:'+$("span",l).css("color")+'">'+h+'</h3><span class="chatbox-change-mess"></span>'}).appendTo("#chatbox-list")}t.html(zzEmoFb.checkEmo(o[1]+o[9])),e.appendTo(i)}}else-1!==a.indexOf("{HIDDEN_TEXT}")||(t.html(zzEmoFb.checkEmo(t.html())),e.appendTo('.chatbox-content[data-id="publish"]'));var d=e.closest(".chatbox-content").attr("data-id"),u=$(".chatbox-change[data-id='"+d+"']");if(a=t.text(),"/buzz"===a)t.html('<img src="http://i.imgur.com/9GvQ6Gd.gif" width="62" height="16" />'),firstTime||"-1px"===$("#chatbox-main").css("left")||(u.click(),$("#chatbox-forumvi").addClass("chatbox-buzz"),$("#chatbox-buzz-audio")[0].play(),setTimeout(function(){$("#chatbox-forumvi").removeClass("chatbox-buzz"),$messenger.focus()},1e3));else if(0===a.indexOf("/out")&&"publish"!==d)if(e.find(".user > a").text()===uName){u.add(".chatbox-content[data-id='"+d+"']").hide();var b=decodeURIComponent($.grep(u.data("users"),function(e){return e!==encodeURIComponent(uName)})[0]);userOnline(b).parent().show(),my_getcookie("chatbox_active")===d&&($(".chatbox-change[data-id='publish']").click(),my_setcookie("chatbox_active",d)),e.replaceWith('<p class="chatbox-userout me clearfix">Bạn đã rời khỏi phòng.</p>')}else e.replaceWith('<p class="chatbox-userout clearfix"><strong>'+e.find(".user > a").text()+"</strong> đã rời khỏi phòng.</p>");var m=$(".date-and-time",e),p=m.text(),f=p.match(/\[(\S+)\s(\S+)\]/);m.text("["+f[1]+"]"),e.closest(".chatbox-content").find(".chatbox-date:contains('"+f[2]+"')").length||e.before('<p class="chatbox-date clearfix">'+f[2]+"</p>")}),setTimeout(function(){var e=$('.chatbox-change[data-id="'+my_getcookie("chatbox_active")+'"]');e.length&&e.is(":visible")&&$('.chatbox-change[data-id="'+my_getcookie("chatbox_active")+'"]').click()},200);var a=JSON.parse(sessionStorage.getItem("messCounter")),o=0;if($(".chatbox-content").each(function(){var e=$(this),t=e.attr("data-id"),c=$(".chatbox_row_1, .chatbox_row_2",e).length,n=$(".chatbox-change[data-id='"+t+"']").find(".chatbox-change-mess"),s=c,i=0;a&&a[t]&&(i=parseInt(a[t],10)),s=c-i,0>=s?s="":(o+=s,s="<strong>"+s+"</strong>"),n.html(s)}),o>0){var c=$title.text(),n=/^\(\d+(\)\s.*$)/;c=n.test(c)?"("+o+c.match(n)[1]:"("+o+") "+c,$title.text(c)}setTimeout(function(){$wrap.scrollTop(99999)},300)}},lastMess,filterMess=function(e){var t,a;if(e)a=e.match(/<p class="chatbox_row_(1|2) clearfix">(?:.(?!<p class="chatbox_row_(1|2) clearfix">))*<\/p>$/)[0],void 0===lastMess?(t=e,lastMess=a,newMessage(t)):lastMess!==a&&(t=e.split(lastMess)[1],lastMess=a,newMessage(t));else{lastMess=void 0;var o={};$(".chatbox-content").each(function(){var e=$(this);o[e.attr("data-id")]=e.children("p").length}),sessionStorage.setItem("messCounter",JSON.stringify(o))}$("#chatbox-forumvi:hidden").fadeIn(200),firstTime=!1},quickAction=function(e,t,a,o){a=a?" "+a:"",$("<li>",{"class":"chatbox-action","data-action":"/"+t+a,text:o}).appendTo(e)},menuActionOne=!0,getDone=function(chatsource){if("undefined"!=typeof chatsource){if(0===chatsource.indexOf("<!DOCTYPE html PUBLIC"))return-1!==chatsource.indexOf("You have been banned from the ChatBox")?console.log("Bạn đã bị cấm truy cập chatbox!"):-1!==chatsource.indexOf("You are disconnected")?console.log("Mất kết nối đến máy chủ. Vui lòng đăng nhập lại!"):alert("Error: log01"),clearInterval(refreshFunction),!1;connected=1,eval(chatsource),$("#chatbox-members").html(chatbox_memberlist),$("a","#chatbox-members").each(function(){var e=$(this),t=e.attr("oncontextmenu").split(/\(|,|\)/);e.removeAttr("oncontextmenu");{var a=t[1],o=t[2].slice(1,-1),c=t[3],n=t[4],s=t[5],i=t[6],r=t[7];t[8],t[9]}if($(".chatbox-change > h3").each(function(){var t=$(this);return t.text()==o&&t.parent().is(":visible")?(e.parent().hide(),!1):void 0}),a===c)uId=c,uName=o,$("#chatbox-me > h2").removeClass("online away").addClass(userOnline(uName).closest("ul").prev("h4").attr("class").split(" ")[1]).html('<a href="/u'+a+'" target="_blank" style="color:'+$("span",e).css("color")+'">'+uName+"</a>"),e.parent().remove(),menuActionOne&&(quickAction("#chatbox-title ul","out",!1,"Rời khỏi phòng"),menuActionOne=!1);else{var l=$("<div>").addClass("chatbox-setting");l.insertAfter(e);var h=$("<ul>").addClass("chatbox-dropdown");h.appendTo(l),quickAction(h,"chat",o,"Trò chuyện riêng"),2==n&&(2!=i&&(quickAction(h,"kick",o,"Đuổi khỏi chatbox"),quickAction(h,"ban",o,"Cấm truy cập chat")),1==s&&2==i&&1!=r?quickAction(h,"unmod",o,"Xóa quyền quản lý"):1==s&&2!=i&&quickAction(h,"mod",o,"Thăng cấp quản lý"))}}),$(".chatbox-change > h3").each(function(){var e,t=$(this),a=userOnline(t.text()).closest("ul").prev("h4");a.hasClass("online")?e="online":a.hasClass("away")&&(e="away"),t.parent().removeClass("online away").addClass(e)}),filterMess(chatbox_messages)}},disconnect=function(){clearInterval(refreshFunction),$("#chatbox-action-logout").addClass("isOut"),$(".chatbox-action-checkbox").prop("checked",!1).hide(),$messenger.val("/away"),$form.submit(),$wform.css("bottom","-90px"),setTimeout(function(){$wform.hide()},500),$wrap.css({bottom:0,opacity:.3}),$("#chatbox-tabs").css("opacity",.3)},update=function(){$.ajax({url:"/chatbox/chatbox_actions.forum?archives=1&mode=refresh",type:"get",dataType:"script"}).done(function(e){getDone(e)}).fail(function(){$.post("/chatbox/chatbox_actions.forum?archives=1",{mode:"send",sent:""}).done(function(){$.post("/chatbox/chatbox_actions.forum?archives=1",{mode:"send",sent:"{HIDDEN_TEXT}"}).done(function(){$.ajax({url:"/chatbox/chatbox_actions.forum?archives=1&mode=refresh",type:"get",dataType:"script"}).done(function(e){getDone(e),$("#chatbox-forumvi:hidden").fadeIn(200)})})})})},autoUpdate=function(){refreshFunction=setInterval(function(){update()},3e3)};$.post("/chatbox/chatbox_actions.forum?archives=1",{mode:"send",sent:"{HIDDEN_TEXT}"}).done(function(e){getDone(e),$("#chatbox-forumvi:hidden").fadeIn(200)}),autoUpdate(),$("#chatbox-input-autorefesh").change(function(){$(this).prop("checked")?autoUpdate():clearInterval(refreshFunction)}),$("#chatbox-action-logout").click(function(){var e=$(this);e.hasClass("isOut")?($(".chatbox-action-checkbox").prop("checked",!0).show(),e.removeClass("isOut"),$wform.show(),setTimeout(function(){$wform.css("bottom",0)},10),$wrap.css({bottom:90,opacity:1}),$("#chatbox-tabs").css("opacity",1),setTimeout(function(){$wrap[0].scrollTop=$wrap.prop("scrollHeight")},500),autoUpdate()):disconnect()}),$messenger.on("focus click keydown",function(){var e=$messenger.attr("data-id"),t=$(".chatbox-change[data-id='"+e+"']").find(".chatbox-change-mess"),a=parseInt(t.text(),10);if(a){var o=$(".chatbox-content[data-id='"+e+"']"),c=JSON.parse(sessionStorage.getItem("messCounter"))||{};c[e]=$(".chatbox_row_1, .chatbox_row_2",$(".chatbox-content[data-id='"+e+"']")).length,sessionStorage.setItem("messCounter",JSON.stringify(c));var n=$("p",o).length-a-1,s=$("p:gt("+n+")",o);s.addClass("chatbox-newmess"),setTimeout(function(){s.removeClass("chatbox-newmess")},3e3),$title.text($title.text().replace(/\(\d+\)\s/,"")),t.empty()}}),$("#chatbox-list").on("click",".chatbox-change",function(){var e=$(this);$(".chatbox-change.active").removeClass("active"),e.addClass("active");var t=e.attr("data-id");$(".chatbox-content").hide(),$('.chatbox-content[data-id="'+t+'"]').show();var a="",o=$("#chatbox-title >.chatbox-setting");"publish"!==t?(a=t+e.attr("data-name")+e.attr("data-users"),o.show()):o.hide(),$form.attr("data-key",a),$messenger.add("#chatbox-title").attr("data-id",t),$("#chatbox-title > h2").text($("h3",e).text()),$messenger.focus(),my_setcookie("chatbox_active",t,!1),$wrap[0].scrollTop=$wrap.prop("scrollHeight")}),$("#chatbox-members, #chatbox-title").on("click",".chatbox-action",function(){$messenger.val($(this).attr("data-action")),$form.submit()}),$("#chatbox-hidetab").click(function(){var e,t,a,o=$(this);o.toggleClass(function(){o.hasClass("show")?(e=-271,t=-1,a="hide"):(e=0,t=270,a="show"),$("#chatbox-tabs").css("left",e),$("#chatbox-main").css("left",t),my_setcookie("chatbox_tabs",a,!1)})}),"hide"===my_getcookie("chatbox_tabs")&&$("#chatbox-hidetab").click(),$("#chatbox-option-buzz").click(function(){"BUZZ"===$(this).html()&&($messenger.val("/buzz"),$form.submit())});var sendMessage=function(e){oldMessage=$messenger.val(),$.post("/chatbox/chatbox_actions.forum?archives=1",{mode:"send",sent:e,sbold:$("#chatbox-input-bold").val(),sitalic:$("#chatbox-input-italic").val(),sunderline:$("#chatbox-input-underline").val(),sstrike:$("#chatbox-input-strike").val(),scolor:$("#chatbox-input-color").val()}).done(function(){getDone(data),$messenger.focus()}).fail(function(){console.log("Lỗi! Tin nhắn chưa được gửi."),$messenger.val(oldMessage)})};$form.submit(function(e){e.preventDefault();var t=$messenger.val();if(""!==$.trim(t)){var a=/^\/(chat|gift|toggle|kick|away|ban|unban|mod|unmod|cls|clear|me)(\s(.+))?$/;if(a.test(t)){var o=t.match(a),c=o[1],n=o[3],s=encodeURIComponent(n),i=encodeURIComponent(uName);if(/^(chat|gift|toggle)$/.test(c))if("chat"===c){var r=(decodeURIComponent(n),$('.chatbox-change[data-users="[\\"'+i+'\\",\\"'+s+'\\"]"]'));r.length||(r=$('.chatbox-change[data-users="[\\"'+s+'\\",\\"'+i+'\\"]"]'));var l=userOnline(n);if(r.length)r.show().click();else if(l.length){if(l.parent().hide(),!r.length){var h,d=(new Date).getTime()+"_"+uId,u=l.parent().parent().prev("h4");h=u.hasClass("online")?" online":u.hasClass("online")?" away":"",r=$("<div>",{"class":"chatbox-change"+h,"data-id":d,"data-name":"{}","data-users":'["'+i+'","'+s+'"]',html:'<h3 style="color:'+$("span",l).css("color")+'">'+n+'</h3><span class="chatbox-change-mess"></span>'}).appendTo("#chatbox-list"),r.click(),$("<div>",{"class":"chatbox-content","data-id":d,style:"display: none;"}).appendTo($wrap)}}else r.length?r.removeClass("online away").click():n===uName?console.log("Phát hiện nghi vấn Tự kỷ ^^~"):console.log("Thành viên "+n+" hiện không truy cập!")}else"toggle"===c&&$("#chatbox-hidetab").click();else sendMessage(t)}else{var b=$form.attr("data-key")+t,m=$messenger.attr("data-id");if("/buzz"==t){var p=$("#chatbox-option-buzz");if("BUZZ"===p.html()){var f,x=59;sendMessage(b),p.addClass("disable"),p.html(60),f=setInterval(function(){var e=x--;p.html(e),0>=e&&(clearInterval(f),p.removeClass("disable"),x=59,f=void 0,p.html("BUZZ"))},1e3)}}else"/out"==t&&"publish"!==m?sendMessage(b):sendMessage(b)}$messenger.val("")}});var chooseColor=function(e){$("#chatbox-option-color").css("background",e),$("#chatbox-input-color").val(e.slice(1)),$("#chatbox-messenger").css("color",e)};$("#chatbox-option-color").click(function(){var e=function(e,t,a){return(a?arguments.callee(e,t,a-1):"#")+t[e.floor(e.random()*t.length)]}(Math,"0123456789ABCDEF",5);chooseColor(e),my_setcookie("optionColor",e,!1)});var cookieColor=my_getcookie("optionColor");cookieColor&&chooseColor(cookieColor),$("#chatbox-option-bold, #chatbox-option-italic, #chatbox-option-underline, #chatbox-option-strike").click(function(){var e=$(this);e.toggleClass(function(){var t="1";return e.hasClass("active")&&(t="0"),$("#"+this.id.replace("option","input")).val(t),"active"});var t=[],a="";$("#chatbox-form > input:not(#chatbox-input-color)").each(function(e){var o=this.value;if(t.push(o),"0"!==o)switch(e){case 0:a+="font-weight: bold;";break;case 1:a+="font-style: italic;";break;case 2:a+="text-decoration: underline;";break;case 3:a+="text-decoration: line-through;"}}),$messenger.attr("style",a),my_setcookie("optionCookie",t.join("|"),!0)});var getArrCookie=my_getcookie("optionCookie");getArrCookie&&$.each(getArrCookie.split("|"),function(e,t){"1"===t&&$("#chatbox-option > div").eq(e).click()}),$messenger.on("input",function(){var e=this.value;this.value=e.replace(/\[\/(b|i|u|strike|left|center|right|justify|size|color|font|list|quote|code|spoiler|hide|table|tr|td|flash|youtube|dailymotion|sub|sup|scroll|updown|flipv|fliph|fade|blur|wow|rand)\]|\[(\*|hr)\]/gi,"***")});var CB_disconnect=function(){disconnect()};